Prosody, An XMPP Communication Server
=====================================

`Prosody`_ is a modern XMPP (the Extensible Messaging and Presence Protocol) communication server, which serves the
purpose for communication, e.g. text messaging, audio and video calls, multi-party chatting, etc.

We need to create a database for prosody first:
::

   ne mariadb

Inside the shell of the MariaDB container, run:
::

   mysql -u root -p

After enter the password, you should now be in the MariaDB shell. After replacing ``PASSWORD`` with your password (which
can be generated by running ``cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w N | head -1``, where ``N`` is the length
of the password), run the following commands:

.. code-block:: sql

   CREATE USER 'prosody' IDENTIFIED BY 'PASSWORD';
   CREATE DATABASE prosody;
   GRANT ALL PRIVILEGES ON prosody.* TO 'prosody';
   FLUSH PRIVILEGES;

Press ``Ctrl-D`` twice to exit the MariaDB shell and the container's shell.

Create a directory to store Prosody configuration files:
::

   sudo mkdir -p $DOCKER_SHARE/prosody
   cd $DOCKER_SHARE/prosody
   sudo mkdir -p certs conf.d

Download the default prosody configuration file:
::

   docker pull blowb/prosody
   sudo -s <<< "docker run --rm blowb/prosody cat /etc/prosody/prosody.cfg.lua > prosody.cfg.lua"

Run the following command to modify the default config file to adjust it to run a Docker container, after replacing
'dc=example,dc=com' with the ``LDAP_SUFFIX`` value in :doc:`../install-essential-docker/install-openldap`, and
``PASSWORD`` with the password of the prosody user in MariaDB you've just created:

.. code-block:: bash
   :linenos:

   LDAP_SUFFIX='dc=example,dc=com'
   sudo sed -ri \
    -e 's/(authentication = )\"internal_plain\"/\1\"ldap\"/' \
    -e "1s/^/ldap_base = \"ou=people,$LDAP_SUFFIX\"\n/" \
    -e '1s/^/ldap_server = \"ldap\"\n/' \
    -e '1s/^/ldap_filter = "(cn=$user)"\n/' \
    -e 's/\-\-(storage = \"sql\")/\1/' \
    prosody.cfg.lua
   sudo sed -i '/^storage = "sql"/a\
    sql = { driver = "MySQL", database = "prosody", username = "prosody", password = "PASSWORD", host = "db" }' \
    prosody.cfg.lua


Explanation:

  - **line 3**: use the OpenLDAP server we set up for authentication instead of the internal one;
  - **line 4**: specify the base in the LDAP database;
  - **line 5**: specify the OpenLDAP server;
  - **line 6**: use ``cn`` attribute as the user name;
  - **line 7**: use sql backend for data storage;
  - **line 9-10**: specify MariaDB connection parameters.

You can edit the configuration file and enable additional modules if you want, such as ``carbons`` for message
synchronization, ``mam_sql`` for message archiving, etc.

Put your XMPP server certificate in ``$DOCKER_SHARE/prosody/certs``. If you just want to use a dummy key, run the
following command to copy the dummy key we generated in :doc:`../install-install-essential-docker/install-nginx`:
::

   sudo cp $DOCKER_SHARE/nginx/tls/dummy.* $DOCKER_SHARE/prosody/certs/

Add a virtual host configuration files after replacing ``example.com`` with your domain, and replace ``dummy.crt`` and
``dummy.key`` with your certification and key if you have one:
::

   MY_DOMAIN=example.com
   sudo -s <<EOF
   cat > conf.d/myhost.cfg.lua <<EEOOFF
   VirtualHost "$MY_DOMAIN"

       ssl = {
                   key = "/etc/prosody/certs/dummy.key";
                   certificate = "/etc/prosody/certs/dummy.crt";
       }
   EEOOFF
   EOF

You can create additional configuration host configurations if you need to host more than one domain.

To start the container:
::

   docker run -d -t --restart always -v $DOCKER_SHARE/prosody/prosody.cfg.lua:/etc/prosody/prosody.cfg.lua:ro \
    -v $DOCKER_SHARE/prosody/conf.d:/etc/prosody/conf.d:ro -v $DOCKER_SHARE/prosody/certs:/etc/prosody/certs:ro \
    --name prosody -p 5222:5222 -p 5223:5223 -p 5269:5269 -p 5298:5298 --link mariadb:db --link openldap:ldap \
    blowb/prosody

.. _`Prosody`: http://prosody.im
